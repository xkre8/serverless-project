name: Force Delete AWS Resources

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type FORCE-DELETE to confirm'
        required: true
        default: ''

jobs:
  force-delete:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'FORCE-DELETE'
    
    steps:
    - name: Configure AWS
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-southeast-1
    
    - name: üóëÔ∏è Delete Lambda Functions
      run: |
        echo "Deleting ALL simple-serverless Lambda functions..."
        aws lambda list-functions --query 'Functions[?starts_with(FunctionName, `simple-serverless`)].FunctionName' --output text | tr '\t' '\n' | while read func; do
          if [ ! -z "$func" ]; then
            echo "Deleting Lambda: $func"
            aws lambda delete-function --function-name "$func" || echo "Failed to delete $func"
          fi
        done
        echo "Lambda functions cleanup completed!"
    
    - name: üóëÔ∏è Delete API Gateways
      run: |
        echo "Deleting ALL simple-serverless API Gateways..."
        aws apigateway get-rest-apis --query 'items[?starts_with(name, `simple-serverless`)].{id:id,name:name}' --output text | while read -r id name; do
          if [ ! -z "$id" ]; then
            echo "Deleting API Gateway: $name ($id)"
            aws apigateway delete-rest-api --rest-api-id "$id" || echo "Failed to delete $id"
          fi
        done
        echo "API Gateways cleanup completed!"
    
    - name: üóëÔ∏è Delete IAM Roles
      run: |
        echo "Deleting ALL simple-serverless IAM roles..."
        aws iam list-roles --query 'Roles[?starts_with(RoleName, `simple-serverless`)].RoleName' --output text | tr '\t' '\n' | while read role; do
          if [ ! -z "$role" ]; then
            echo "Processing role: $role"
            # Detach managed policies
            aws iam list-attached-role-policies --role-name "$role" --query 'AttachedPolicies[].PolicyArn' --output text | tr '\t' '\n' | while read policy; do
              if [ ! -z "$policy" ]; then
                echo "Detaching policy: $policy"
                aws iam detach-role-policy --role-name "$role" --policy-arn "$policy" || echo "Failed to detach $policy"
              fi
            done
            # Delete inline policies
            aws iam list-role-policies --role-name "$role" --query 'PolicyNames[]' --output text | tr '\t' '\n' | while read policy; do
              if [ ! -z "$policy" ]; then
                echo "Deleting inline policy: $policy"
                aws iam delete-role-policy --role-name "$role" --policy-name "$policy" || echo "Failed to delete inline policy $policy"
              fi
            done
            # Delete role
            echo "Deleting role: $role"
            aws iam delete-role --role-name "$role" || echo "Failed to delete role $role"
          fi
        done
        echo "IAM roles cleanup completed!"
    
    - name: ‚úÖ Verify Deletion
      run: |
        echo "=================================="
        echo "üîç Verifying deletion..."
        echo "=================================="
        
        echo "Lambda functions:"
        aws lambda list-functions --query 'Functions[?starts_with(FunctionName, `simple-serverless`)].FunctionName' --output table || echo "No Lambda functions found"
        
        echo "API Gateways:"
        aws apigateway get-rest-apis --query 'items[?starts_with(name, `simple-serverless`)].{Name:name,Id:id}' --output table || echo "No API Gateways found"
        
        echo "IAM Roles:"
        aws iam list-roles --query 'Roles[?starts_with(RoleName, `simple-serverless`)].{RoleName:RoleName}' --output table || echo "No IAM roles found"
        
        echo "=================================="
        echo "üéâ Force deletion completed!"
        echo "=================================="
